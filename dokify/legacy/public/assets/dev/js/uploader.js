define(function(b,a,c){var f,d;d=0;f="async_upload_";function e(r){var g,m,n,h,t,o,l;r=$(r);t=null;o=0;g=r.parent();n=g.find("button");h=r.outerWidth();
m=r.data("disable");l=r.data("navigate")!==undefined;if(n.length==0){n=g.find("a");}if(m){var k=n.html();r.on("complete",function(){n.html(k).removeAttr("disabled");
r.removeAttr("disabled");});}function j(v,u){if(u==200){r.trigger("success",[v,u,t,l]);}else{r.trigger("error",[v,u,t,l]);}}function s(u){var v=Math.round((u.loaded*100)/u.total);
if(v==100){v=99.9;}r.trigger("progress",[v,u]);}function q(u,v){t=new XMLHttpRequest();if(o&&v.size>o){return j(null,413);}t.upload.onprogress=s;if(l){$(document).trigger("navigate:lock");
$(document).trigger("navigate:before",[t]);}t.open("put",u,true);t.setRequestHeader("Content-Type","multipart/form-data");t.setRequestHeader("X-File-Name",encodeURIComponent(v.name));
t.setRequestHeader("X-File-Size",v.size);t.setRequestHeader("X-File-Type",v.type||"");t.onreadystatechange=function(){if(t.readyState==4){var w,x;w=t.responseText;
x=t.getResponseHeader("Content-type");if(x.indexOf("application/json")!==-1){w=$.parseJSON(w);}j(w,t.status);}};t.send(v);if(m){r.attr("disabled",true);
n.attr("disabled",true).html(m);}r.trigger("progress",[0,t]);}function p(v,F){var w,z,D,u,C,G,y,B,x,E,A;if(F.form){w=F.form;z=w.action;D=w.enctype;u=w.method;
C=$(w).attr("target");G=$._data(w,"events");B=v.indexOf("?")===-1?"?":"&";E=f+(d++);y=[];x=$(document.createElement("iframe"));x.attr({id:E,name:E}).appendTo("body");
t=x;if(l){$(document).trigger("navigate:lock");$(document).trigger("navigate:before",[t]);}if(G&&G.submit){for(A in G.submit){if(!isNaN(A)&&G.submit.hasOwnProperty(A)){y.push(G.submit[A].handler);
}}$(w).off("submit");}$(x).one("load",function(){x.remove();setTimeout(function(){j();},1000);});window[E]=function(H,I){I=I||500;$(x).unbind("load").remove();
j(H,I);window[E]=undefined;};$(w).attr({action:v+B+"callback="+E,enctype:"multipart/form-data",method:"post",target:E}).submit();if(m){n.attr("disabled",true).html(m);
}$(w).attr({action:z,enctype:D,method:u,target:C});for(A in y){$(w).on("submit",y[A]);}}}this.setMaxSize=function(u){o=u;};this.abort=function(){if(t){if(window.File&&r.files){t.onreadystatechange=function(){};
t.abort();}else{$(t).remove();}}};this.submit=function(u){if(window.File&&r.get(0).files){return q(u,r.get(0).files[0]);}else{return p(u,r.get(0));}};this.mousein=function(){n.addClass("hover");
};this.mouseout=function(){n.removeClass("hover");};r.hover(this.mousein,this.mouseout);r.css("left",n.outerWidth()-h);}e.init=function(){var q,h,o,g,l,j,k;
q=$(this);h=$(this.form);g=this.name;l=new e(this);o=(o=q.data("display"))?o.find():null;function n(s,t){var r=(q).data("message-"+s);if(r){return r;}if(t){return t;
}return s;}function p(u,r){var s,t,v;if(!u){return n(r);}v=u.getResponseHeader("Content-type");if(u.responseText&&v.indexOf("application/json")!==-1){s=$.parseJSON(u.responseText);
}if(s&&s.error&&s.error.message){return s.error.message;}return n(u.status,u.statusText);}function m(v,t,r,w,s){var u;if(w.readyState>0){u=p(w);}if(!u&&t&&t.error&&t.error.message){u=t.error.message;
}if(!u){u=r;}$(document).trigger("message:error",[u]);if(o){o.html('<strong class="red">'+u+"</strong>");}q.trigger("progress",[100]);q.trigger("complete",[t,r,w]);
q.val("");if(s){$(document).trigger("navigate:stop",[w]);}}q.on("success",function(w,u,s,x,t){var r=q.data("success"),v;if(r){u.display=q.data("display");
u["display-status"]=q.data("display-status");q.trigger("progress",[NaN]);$.ajax({url:r,type:"post",data:u,dataType:"json",success:function(z,y,A){q.trigger("progress",[100]);
q.trigger("complete",[z,y,A]);if(t){$(document).trigger("navigate:stop",[A]);}$(document).trigger("json:response",[z]);},error:function(z,y){q.trigger("error",["",y,z]);
}});}else{q.trigger("progress",[100]);q.trigger("complete",[u,s,x]);if(v=q.data("display")){v.find().html(u.name);}if(t){$(document).trigger("navigate:stop",[x]);
}}q.val("");for(i in u){j=g+"["+i+"]";k=h.find("input[name="+g+"\\["+i+"\\]]");if(k.length==0){k=$(document.createElement("input")).attr({type:"hidden",name:j}).insertAfter(q);
}k.val(u[i]);}}).on("error",m);q.on("change",function(){if(o){o.empty();}l.submit("/app/upload");});};return e;});