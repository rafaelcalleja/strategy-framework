define(["checklist"],function(e){function d(i,g){var f,h;f=this;this.dom=i;this.uid=$(i).data("uid");this.domLite=$("#assignment-lite-"+$(i).data("lite"));
this.name=$(i).data("name");this.organization=g;this.bounce={uid:$(i).data("bounce-uid"),name:$(i).data("bounce-name"),};this.group=c.create(this,$(i).data("group"));
this.group.hide();$(i).on("click","a[target=remove]",function(j){j.preventDefault();f.destroy();});$(i).on("mouseenter","span.bounce",function(j){var k=f.organization.set.findAssignmet(f.bounce.uid);
if(k){$(k.dom).addClass("highlight");}});$(i).on("mouseleave","span.bounce",function(j){var k=f.organization.set.findAssignmet(f.bounce.uid);if(k){$(k.dom).removeClass("highlight");
}});}d.prototype.show=function(){var g,f;this.organization.assignments[this.uid]=this;this.organization.checklist.groups.deleteItem(this.dom);this.organization.checklist.assignments.addItem(this.dom);
$(this.organization.list.assignments).find("li:first").after(this.dom);if(g=this.organization.set.findAssignmet(this.bounce.uid)){f=$(this.dom).addClass("bounce").find("span.bounce");
f.attr("title",g.organization.name+" - "+g.name);}$(document).trigger("redraw",this.dom);};d.prototype.destroy=function(){var i,h,g={},f;i=this;h=this.organization;
f="/app/assignment/"+this.uid+"/";i.loading(true);h.blockAssignmentOptions();$.ajax(f,{method:"delete"}).done(function(l){var m,n;i.loading(false);h.unblockAssignmentOptions();
for(var k in l.remove){m=l.remove[k];n=h.set.findAssignmet(m.uid);if(n){h.checklist.assignments.deleteItem($(n.dom));delete n.organization.assignments[n.uid];
$(n.dom).remove();$(n.domLite).remove();n.group.show();n.organization.isMandatory=m.mandatory_message;g[n.organization.uid]=n.organization;}}for(var j in g){g[j].render();
}h.render();if(0!==Object.keys(h.assignments).length){h.checklist.assignments.remove();h.checklist.assignments.filter();}$(document).trigger("json:response",[l]);
}).fail(function(){$(assignment.dom).show();});};d.prototype.loading=function(f){if(f){$(this.dom).addClass("loading");}else{$(this.dom).removeClass("loading");
}};function c(h,g){var f=this;this.dom=h;this.uid=$(h).data("uid");this.organization=g;$(h).on("click","a[target=suggest]",function(i){i.preventDefault();
f.suggest();});}c.create=function(i,f){var h,g;h=$("#group-"+f);g=new c(h,i.organization);return g;};c.prototype.destroy=function(){delete this.organization.groups[this.uid];
$(this.dom).remove();};c.prototype.hide=function(){$(this.dom).addClass("assigned").removeClass("unassigned");};c.prototype.show=function(){this.organization.groups[this.uid]=this;
this.organization.checklist.assignments.deleteItem(this.dom);this.organization.checklist.groups.addItem(this.dom);$(this.dom).removeClass("bounce");$(this.organization.list.groups).find("li:first").after(this.dom);
$(this.dom).addClass("unassigned").removeClass("assigned");$(document).trigger("redraw",this.dom);};c.prototype.getData=function(){var f={};f.uid=this.uid;
f.item=this.organization.set.item;f.organization=this.organization.uid;return f;};c.prototype.suggest=function(){$(this.dom).addClass("suggested");$(this.dom).on("counter:cancel",function(f){$(this).removeClass("suggested");
});};c.prototype.loading=function(f){if(f){$(this.dom).addClass("loading");}else{$(this.dom).removeClass("loading");}};d.prototype.blockDeleteOption=function(){$(this.dom).find(".locked-option").removeClass("hidden");
$(this.dom).find(".delete-option").addClass("hidden");};d.prototype.unblockDeleteOption=function(){$(this.dom).find(".locked-option").addClass("hidden");
$(this.dom).find(".delete-option").removeClass("hidden");};function b(j,k){var h=this;this.dom=j;this.uid=$(j).data("uid");this.name=$(j).data("name");
this.isOnDemand=$(j).data("on-demand");this.assignments={};this.groups={};this.isMandatory=false;this.set=k;this.assignButton=$(j).find(".assign-button");
this.loadingAssignButton=$(j).find(".assign-button-loading");this.list={assignments:$(j).find("ul.assignments").get(0),groups:$(j).find("ul.groups").get(0)};
this.checklist={assignments:new e(this.list.assignments),groups:new e(this.list.groups)};var g=$(this.list.assignments).find("li.assignment");g.each(function(){var l=new d(this,h);
h.assignments[l.uid]=l;});var f=$(this.list.groups).find("li.group.unassigned");f.each(function(){var l=new c(this,h);h.groups[l.uid]=l;});this.showBox=$(this.dom).find(".organization-view");
this.editBox=$(this.dom).find(".organization-edit");this.showOrganizationEditButton=$(j).find(".show-organization-edit");this.showOrganizationEditButton.on("click",function(l){h.showEditMode();
});$(j).find(".close-organization-edit").on("click",function(l){h.closeEditMode();});var i=$(j).find("input.select-all-groups");$(i).on("click",function(n){var l=$(j).find(".group.unassigned.show-item");
var m=$(this).is(":checked");l.each(function(){var o=$(this).find("input");$(o).prop("checked",m);});});this.searchAssignments=$(this.dom).find(".search-assignments");
this.searchGroups=$(this.dom).find(".search-groups");$(j).find("a.toggle").on("click",function(l){$(j).find("div.organization-title").toggleClass("toggle-open");
});this.assignButton.on("click",function(m){var l=h.set.set;$(l).each(function(){this.activeLoadingAssignButton();});});}b.prototype.showEditMode=function(){this.showBox.addClass("hidden").removeClass("visible");
this.editBox.addClass("visible").removeClass("hidden");if(true===this.isOnDemand){$(this.dom).find(".autofocus,[autofocus]").first().focus();}};b.prototype.closeEditMode=function(){this.showBox.addClass("visible").removeClass("hidden");
this.editBox.addClass("hidden").removeClass("visible");};b.prototype.activeLoadingAssignButton=function(){this.loadingAssignButton.addClass("visible").removeClass("hidden");
this.assignButton.addClass("hidden").removeClass("visible");};b.prototype.blockAssignmentOptions=function(){var h=this.assignments;var g=this;for(var f in h){var i=g.set.findAssignmet(f);
if(typeof i.bounce.uid==="undefined"){i.blockDeleteOption();}}};b.prototype.unblockAssignmentOptions=function(){var h=this.assignments;var g=this;for(var f in h){var i=g.set.findAssignmet(f);
if(typeof i.bounce.uid==="undefined"){i.unblockDeleteOption();}}};b.prototype.render=function(){var f,g,i,h;f=Object.keys(this.assignments).length;g=Object.keys(this.groups).length;
h=$(this.dom).find(".message-organization");if(f==0){$(this.list.assignments).addClass("empty");i=$(this.list.assignments).find(".message.mandatory.visible");
if(this.isMandatory&&i.length==0){$(this.list.assignments).find(".message").toggleClass("hidden visible");$(this.list.assignments).addClass("mandatory");
}this.showOrganizationEditButton.addClass("visible").removeClass("hidden");h.addClass("visible").removeClass("hidden");}if(f>1){$(this.list.assignments).removeClass("empty");
h.addClass("hidden").removeClass("visible");}if(g==0&&false===this.isOnDemand){this.showOrganizationEditButton.addClass("hidden").removeClass("visible");
}else{this.showOrganizationEditButton.addClass("visible").removeClass("hidden");}this.renderSearchboxes();};b.prototype.renderSearchboxes=function(){var f,g;
f=Object.keys(this.assignments).length;g=Object.keys(this.groups).length;if(g<5){this.searchGroups.hide();}else{this.searchGroups.show();}if(f<5){this.searchAssignments.hide();
}else{this.searchAssignments.show();}};function a(g){var f;f=this;this.dom=g;this.set=[];this.item={uid:$(g).data("item-uid"),module:$(g).data("item-module")};
$(g).find(".organization").each(function(){var h=new b(this,f);h.render();f.set.push(h);});}a.prototype.find=function(h,g){var j,i,f;j=this.set.length;
while(j--){f=this.set[j];if(i=f[g][h]){return i;}}};a.prototype.findGroup=function(f){return this.find(f,"groups");};a.prototype.findAssignmet=function(f){return this.find(f,"assignments");
};a.init=function(){new a(this);};return a;});